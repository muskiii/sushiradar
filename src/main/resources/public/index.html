<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Title of the document</title>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <script src="https://cdnjs.clou	dflare.com/ajax/libs/typeahead.js/0.10.4/dist/typeahead.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead-addresspicker/0.1.4/typeahead-addresspicker.min.js"></script>
</head>
<body>

<label>Buscador</label>
<input  id="buscador" type="text" placeholder="argen">

<input id="city" type="hidden">
<input id="country" type="hidden">

<button id="btnGet">buscar</button>
<button id="btnSend">guardar</button>

<p id="forecast">mmm...</p>

<pre class="response" id="response"></pre>
<input id="forecast-data" type="hidden">

<script type="text/javascript">
    $(document).ready(function () {
        $("#btnGet").click(function () {
            let city = encodeURIComponent($('#city').text());
            let country = encodeURIComponent($('#country').text());
            if (city != "" || country != "") {
                $.ajax({
                    type: 'GET',
                    url: '/forecast?city=' + city + '&country=' + country,
                    error: function () {
                        $('#forecast').html('ERROR');
                    },
                    success: function (data) {
                        if (!data.response.hasOwnProperty('error') && !data.response.hasOwnProperty('results')) {
                            $("#forecast-data").text(JSON.stringify(data));
                            $("#forecast").text("ok");
                        } else {
                            $('#forecast').text('Nothing Here');
                        }
                    }
                });
            } else {
                $("#forecast").text("empty fields");
            }
        });
        $("#btnSend").click(function () {
            if ($("#forecast-data").text() != "" && $("#forecast-data").text() != "ERROR") {
	            if ($("#forecast-data").text().indexOf("results") == -1){
		            let data = JSON.parse($('#forecast-data').text());     
		            data.target = 'something';
		                   
	                $.ajax({
	                    type: 'POST',
	                    url: '/forecast',
	                    data:  JSON.stringify(data),
	                    contentType: 'application/json',
	                    success: function (data) {
	                        $("#forecast").text("OK");
	                    },
	                    error: function () {
	                        $('#forecast').text('ERROR');
	                    }
	                });
	            }else{
	           		$("#forecast").text("ERROR");
	            }
            }
        });

        var addressPicker = new AddressPicker();

        $('#buscador').typeahead(null, {
            displayKey: 'description',
            source: addressPicker.ttAdapter()
        });
        addressPicker.bindDefaultTypeaheadEvent($('#buscador'))
        $(addressPicker).on('addresspicker:selected', function (event, result) { displayResults(result, $('#response'))})
        $(addressPicker).on('addresspicker:predictions', function(event, result) {
            if (result && result.length > 0)
                $('#buscador').removeClass("empty")
            else
                $('#buscador').addClass("empty")
        })

        function displayResults(result, div) {
            result.addressTypes().forEach(function(type) {
                if (type == "country"){
                    $("#country").text(result.nameForType(type).replace(/ /g,"_"));
                }
                if (type == "political"){
                    $("#city").text(result.nameForType(type).replace(/ /g,"_"));
                }

            })
            html = ["Address: " + result.address()]
            html.push("Latitude: " + result.lat())
            html.push("Longitude: " + result.lng())
            html.push("Long names:")
            result.addressTypes().forEach(function(type) {
                html.push("  " + type + ": " + result.nameForType(type))
            })
            html.push("Short names:")
            result.addressTypes().forEach(function(type) {
                html.push("  " + type + ": " + result.nameForType(type, true))
            })
            div.html( html.join('\n'));
        }
    });
</script>
</body>
</html>